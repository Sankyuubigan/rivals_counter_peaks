#29.05.25
Хорошо, вот краткий список проблем, которые мы пытались решить, и того, что не получилось или осталось под вопросом:

1.  **Проблема с хоткеями при старте (не работают до переназначения) и правами администратора:**
    *   **Попытка:** Увеличение задержки запуска слушателя хоткеев в `MainWindow.showEvent` до 1000мс. Добавление подробного логирования в `HotkeyManager` для отслеживания состояния слушателя.
    *   **Результат:** Проблема, вероятно, осталась (по вашему последнему сообщению, хоткеи снова не работают). Требуется дальнейшая диагностика, почему первоначальный запуск слушателя неэффективен.

2.  **Проблема с `SystemError: ... returned NULL without setting an exception` (для `QLabel`, `QFrame`, `QMenu`):**
    *   **Попытка (SettingsWindow):** Отложить вызов `_populate_hotkey_list_ui` в `SettingsWindow` с помощью `QTimer.singleShot(0, ...)`, чтобы он выполнялся после полной инициализации диалога.
    *   **Попытка (UiUpdater):** Добавить `QApplication.processEvents()` после удаления старых панелей в `UiUpdater` перед созданием новых, чтобы дать Qt время обработать `deleteLater()`.
    *   **Результат:** Логи показывают, что `SystemError` все еще возникают при определенных сценариях (например, при создании `QMenu` в `TopPanel._show_main_menu`, и при создании виджетов в `UiUpdater` и `LeftPanel` при смене режима), хотя для `SettingsWindow` ошибка могла уйти благодаря отложенному вызову. Это указывает на более общую проблему сタイミングом создания виджетов Qt.

3.  **Дублирование элементов в окне настроек хоткеев:**
    *   **Попытка:** Улучшение логики очистки `QGridLayout` в `SettingsWindow._populate_hotkey_list_ui` и перенос вызова `_load_settings_and_populate_ui` только в методы `open()` и `exec()` (убрав `QTimer.singleShot` из `__init__`).
    *   **Результат:** По вашему последнему скриншоту, проблема с дублированием (или неполной отрисовкой, где элементы накладываются) все еще присутствует.

4.  **Проблема с отображением компактного режима (лишние элементы):**
    *   **Попытка:** Модификация `UiUpdater.update_interface_for_mode` для корректного скрытия/отображения панелей (`left_panel_widget`, `right_panel_widget`, `icons_scroll_area`) и управления высотой окна для `min` режима.
    *   **Результат:** По вашему последнему сообщению, кнопки смены режима пропали из компактного режима, что является регрессией. Ошибка `RuntimeError: Internal C++ object (PySide6.QtWidgets.QLabel) already deleted` при смене режима также указывает на проблемы с жизненным циклом виджетов в `UiUpdater`.

5.  **Лишняя кнопка "Изменить" в настройках хоткеев (до того, как началось полное дублирование):**
    *   **Попытка:** Анализ кода `SettingsWindow._populate_hotkey_list_ui`.
    *   **Результат:** Не было найдено очевидной причины для *одной* лишней кнопки. Проблема с полным дублированием строк, возможно, скрыла или заменила эту специфическую ошибку.

**Нерешенные ключевые моменты (до 03.06.25):**

*   Стабильная работа хоткеев при запуске приложения без необходимости их переназначения.
*   Устранение ошибок `SystemError: ... returned NULL ...` при создании виджетов Qt в различных частях приложения (особенно при динамическом обновлении UI).
*   Корректное отображение и очистка UI в окне настроек хоткеев, устранение дублирования/наложения элементов.
*   Полностью корректное отображение всех элементов UI во всех режимах окна, особенно в компактном.

---
# 03.06.25 - Переход на библиотеку `keyboard` и исправление ошибок

**Проблема:** "Залипание" хоткеев, некорректная работа менеджера хоткеев на базе `pynput`.

**Решение и этапы:**

1.  **Анализ и выбор новой библиотеки:**
    *   Рассмотрены варианты: улучшение `pynput`, библиотека `keyboard`, встроенные средства Qt, платформо-специфичные API.
    *   **Выбрана библиотека `keyboard`** как наиболее сбалансированное решение для глобальных кроссплатформенных хоткеев с более простым управлением состоянием.

2.  **Интеграция `keyboard`:**
    *   Добавлена `keyboard` в `requirements.txt`.
    *   Создан новый класс `core/keyboard_hotkey_adapter.py` для инкапсуляции работы с библиотекой `keyboard`.
        *   Реализована логика регистрации (`add_hotkey`) и отмены регистрации (`remove_hotkey`) хоткеев.
        *   Реализована нормализация строк хоткеев из внутреннего формата в формат, понятный библиотеке `keyboard`.
        *   Обеспечен безопасный вызов действий GUI из потока `keyboard` через `QMetaObject.invokeMethod`.
    *   Старый `core/hotkey_manager.py` (на базе `pynput`) был заменен использованием нового адаптера в `MainWindow`.
    *   `core/hotkey_parser_utils.py` был упрощен, осталась только функция `normalize_string_for_storage` для внутреннего формата.

3.  **Адаптация `HotkeyCaptureLineEdit`:**
    *   Поле ввода хоткеев (`core/ui_components/hotkey_capture_line_edit.py`) было изменено для генерации строк хоткеев во внутреннем формате (который затем преобразуется адаптером).
    *   Исправлена логика захвата комбинаций, особенно с клавишей `Tab` и Numpad-клавишами, чтобы они корректно распознавались как часть комбинации. Несколько итераций правок для корректной обработки `Tab` как модификатора и как основной клавиши, а также для правильного захвата Numpad-операторов.

4.  **Отладка проблем с `keyboard`:**
    *   **Проблема "зависания" при запуске:**
        *   Локализована до первого взаимодействия с библиотекой `keyboard` в методе `load_and_register_hotkeys`.
        *   Выяснилось, что проблема возникала при вызове `_unregister_all_keyboard_lib_hotkeys` при первом запуске, когда не было зарегистрированных хоткеев. Исправлено добавлением проверки на пустой список зарегистрированных хоткеев перед попыткой их удаления.
    *   **Проблема неработающих Numpad-хоткеев:**
        *   Обнаружено, что `keyboard` не распознает некоторые нормализованные имена Numpad-клавиш (например, `keypad *`, `keypad /`, `multiply`, `divide`).
        *   Метод `_normalize_hotkey_string_for_keyboard_lib` в `KeyboardHotkeyAdapter` был несколько раз скорректирован для использования имен/символов, которые `keyboard` распознает (например, `num 0` для цифр, `decimal` для точки, `subtract` для минуса, и в итоге `*` и `/` для умножения и деления на Numpad).

5.  **Обновление `MainWindow` и `SettingsWindow`:**
    *   `MainWindow` теперь использует `KeyboardHotkeyAdapter`. Обновлена логика инициализации, применения настроек и закрытия приложения.
    *   `SettingsWindow` теперь получает конфигурацию хоткеев из `AppSettingsManager` (который хранит их во внутреннем формате) и корректно передает их `KeyboardHotkeyAdapter` после сохранения.
    *   `HotkeyDisplayDialog` адаптирован для отображения хоткеев, используя актуальную конфигурацию из `KeyboardHotkeyAdapter`.

**Результат:**

*   Проблема "зависания" приложения при запуске, связанная с инициализацией хоткеев, решена.
*   Хоткеи, включая переназначенные и использующие Numpad-клавиши, теперь корректно регистрируются и работают.
*   Процесс переназначения хоткеев в GUI работает корректно.

**Замечание:** Сообщение "None of PyTorch, TensorFlow >= 2.0, or Flax have been found." при запуске относится к библиотеке `transformers` и не связано с хоткеями. Оно информирует, что не найдены фреймворки для глубокого обучения, и `transformers` будет работать в ограниченном режиме (например, только для токенизации или загрузки конфигураций, что для текущего проекта может быть достаточно, так как используется ONNX-модель).